services:

  mysql:
    env_file: .env
    image: mysql:${MYSQL_IMAGE_TAG:-8.0}
    container_name: ${CONTAINER_NAME_MYSQL:-scrapsama_mysql}
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    command: --default-authentication-plugin=mysql_native_password --log_error_verbosity=3
    ports:
      - "${MYSQL_HOST_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - scrapsama_network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p$${MYSQL_ROOT_PASSWORD}" ]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 180s

  phpmyadmin:
    env_file: .env
    image: phpmyadmin:${PMA_IMAGE_TAG:-latest}
    platform: linux/arm64
    container_name: ${CONTAINER_NAME_PMA:-scrapsama_phpmyadmin}
    restart: unless-stopped
    environment:
      PMA_HOST: ${MYSQL_HOST:-mysql}
      PMA_PORT: ${MYSQL_HOST_PORT:-3306}
      PMA_USER: ${MYSQL_ROOT_USER:-root}
      PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      UPLOAD_LIMIT: ${PMA_UPLOAD_LIMIT:-300M}
    ports:
      - "${PMA_HOST_PORT:-8080}:80"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - scrapsama_network

  flaresolverr:
    env_file: .env
    image: ghcr.io/flaresolverr/flaresolverr:${FLARESOLVERR_IMAGE_TAG:-latest}
    container_name: ${CONTAINER_NAME_FLARESOLVERR:-scrapsama_flaresolverr}
    restart: unless-stopped
    environment:
      - LOG_LEVEL=${FLARESOLVERR_LOG_LEVEL:-info}
      - LOG_HTML=${FLARESOLVERR_LOG_HTML:-false}
      - CAPTCHA_SOLVER=${FLARESOLVERR_CAPTCHA_SOLVER:-none}
      - TZ=Europe/Paris
      - HEADLESS=${FLARESOLVERR_HEADLESS:-true}
      - BROWSER_TIMEOUT=${FLARESOLVERR_BROWSER_TIMEOUT:-40000}
      - TEST_URL=${FLARESOLVERR_TEST_URL:-https://www.google.com}
    ports:
      - "${FLARESOLVERR_HOST_PORT:-8191}:8191"
    networks:
      - scrapsama_network

  app:
    env_file: .env
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: ${PYTHON_VERSION:-3.12-slim}
    container_name: ${CONTAINER_NAME_APP:-scrapsama_app}
    restart: unless-stopped
    environment:
      DB_HOST: ${MYSQL_HOST:-mysql}
      DB_PORT: ${MYSQL_HOST_PORT:-3306}
      DB_NAME: ${MYSQL_DATABASE}
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      FLARESOLVERR_URL: ${FLARESOLVERR_URL:-http://flaresolverr:8191/v1}
      FLARESOLVERR_ENABLED: ${FLARESOLVERR_ENABLED:-true}
    volumes:
      - ./scraper:/app/scraper
    depends_on:
      mysql:
        condition: service_healthy
      flaresolverr:
        condition: service_started
    networks:
      - scrapsama_network
    stdin_open: true
    tty: true

  web:
    env_file: .env
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        PYTHON_VERSION: ${PYTHON_VERSION:-3.12-slim}
    container_name: ${CONTAINER_NAME_WEB:-scrapsama_web}
    restart: unless-stopped
    environment:
      DB_HOST: ${MYSQL_HOST:-mysql}
      DB_PORT: ${MYSQL_HOST_PORT:-3306}
      DB_NAME: ${MYSQL_DATABASE}
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      FLARESOLVERR_URL: ${FLARESOLVERR_URL:-http://flaresolverr:8191/v1}
      FLARESOLVERR_ENABLED: ${FLARESOLVERR_ENABLED:-true}
    ports:
      - "${WEB_HOST_PORT:-5000}:5000"
    volumes:
      - ./webapp:/app/webapp
      - ./scraper:/app/scraper
    depends_on:
      mysql:
        condition: service_healthy
      flaresolverr:
        condition: service_started
    networks:
      - scrapsama_network

networks:
  scrapsama_network:
    driver: bridge

volumes:
  mysql_data:
