services:

  vpn:
    env_file: .env
    build:
      context: .
      dockerfile: Dockerfile.vpn
    container_name: ${CONTAINER_NAME_VPN}
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    environment:
      - PROTONVPN_USERNAME=${PROTONVPN_USERNAME}
      - PROTONVPN_PASSWORD=${PROTONVPN_PASSWORD}
      - PROTONVPN_SERVER=${PROTONVPN_SERVER}
      - PROTONVPN_CONFIG_URL=${PROTONVPN_CONFIG_URL:-}
    volumes:
      - ./vpn-config/protonvpn.ovpn:/vpn/config/protonvpn.ovpn:ro
      - vpn_credentials:/vpn/credentials
    ports:
      - "${FLARESOLVERR_HOST_PORT}:8191"
      - "${WEB_HOST_PORT}:5000"
    networks:
      - scrapsama_network
    dns:
      - 1.1.1.1
      - 1.0.0.1
    healthcheck:
      test: ["CMD", "sh", "-c", "ip link show tun0 2>/dev/null && ping -c 1 -W 5 1.1.1.1 || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 10
      start_period: 120s

  mysql:
    env_file: .env
    image: mysql:${MYSQL_IMAGE_TAG}
    container_name: ${CONTAINER_NAME_MYSQL}
    restart: unless-stopped
    profiles:
      - mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "${MYSQL_HOST_PORT}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - scrapsama_network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p$${MYSQL_ROOT_PASSWORD}" ]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 180s

  phpmyadmin:
    env_file: .env
    image: phpmyadmin:${PMA_IMAGE_TAG}
    container_name: ${CONTAINER_NAME_PMA}
    restart: unless-stopped
    profiles:
      - pma
    environment:
      PMA_HOST: ${MYSQL_HOST}
      PMA_PORT: 3306
      PMA_USER: ${MYSQL_ROOT_USER}
      PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      UPLOAD_LIMIT: ${PMA_UPLOAD_LIMIT}
    ports:
      - "${PMA_HOST_PORT}:80"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - scrapsama_network

  flaresolverr:
    env_file: .env
    image: ghcr.io/flaresolverr/flaresolverr:${FLARESOLVERR_IMAGE_TAG}
    container_name: ${CONTAINER_NAME_FLARESOLVERR}
    restart: unless-stopped
    network_mode: "service:vpn"
    environment:
      - LOG_LEVEL=${FLARESOLVERR_LOG_LEVEL}
      - LOG_HTML=${FLARESOLVERR_LOG_HTML}
      - CAPTCHA_SOLVER=${FLARESOLVERR_CAPTCHA_SOLVER}
      - TZ=Europe/Paris
      - HEADLESS=${FLARESOLVERR_HEADLESS}
      - BROWSER_TIMEOUT=${FLARESOLVERR_BROWSER_TIMEOUT}
      - TEST_URL=${FLARESOLVERR_TEST_URL}
    depends_on:
      vpn:
        condition: service_healthy

  app:
    env_file: .env
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: ${PYTHON_VERSION}
    container_name: ${CONTAINER_NAME_APP}
    restart: unless-stopped
    network_mode: "service:vpn"
    environment:
      DB_HOST: ${MYSQL_HOST}
      DB_PORT: 3306
      DB_NAME: ${MYSQL_DATABASE}
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      ANIME_SAMA_URL: ${ANIME_SAMA_URL}
      FLARESOLVERR_URL: ${FLARESOLVERR_URL}
      FLARESOLVERR_ENABLED: ${FLARESOLVERR_ENABLED}
#    volumes:
#      - ./scraper:/app/scraper
    depends_on:
      vpn:
        condition: service_healthy
      flaresolverr:
        condition: service_started
    stdin_open: true
    tty: true

  web:
    env_file: .env
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        PYTHON_VERSION: ${PYTHON_VERSION}
    container_name: ${CONTAINER_NAME_WEB}
    restart: unless-stopped
    profiles:
      - web
    network_mode: "service:vpn"
    environment:
      DB_HOST: ${MYSQL_HOST}
      DB_PORT: 3306
      DB_NAME: ${MYSQL_DATABASE}
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      ANIME_SAMA_URL: ${ANIME_SAMA_URL}
      FLARESOLVERR_URL: ${FLARESOLVERR_URL}
      FLARESOLVERR_ENABLED: ${FLARESOLVERR_ENABLED}
    volumes:
      - ./webapp:/app/webapp
      - ./scraper:/app/scraper
    depends_on:
      vpn:
        condition: service_healthy
      flaresolverr:
        condition: service_started

networks:
  scrapsama_network:
    driver: bridge

volumes:
  mysql_data:
  vpn_credentials:
