{% extends "base.html" %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Accueil</a> / 
    <a href="/series/{{ episode.serie_id }}">{{ episode.serie_name }}</a> / 
    <a href="/season/{{ episode.season_id }}">{{ episode.season_name }}</a> / 
    <span>{{ episode.episode_name }}</span>
</div>

<div class="episode-header">
    <h1>{{ episode.serie_name }} - {{ episode.season_name }}</h1>
    <h2>{{ episode.episode_name }}</h2>
</div>

<div class="player-section">
    {% if players %}
    <div class="player-controls">
        <div class="language-selector">
            <label for="language-select">Langue:</label>
            <select id="language-select">
                {% for lang in players.keys() %}
                <option value="{{ lang }}">{{ lang }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="player-selector">
            <label for="player-select">Lecteur:</label>
            <select id="player-select">
                <!-- Will be populated by JavaScript -->
            </select>
        </div>
    </div>
    
    <div class="player-container">
        <iframe id="player-frame" src="" allowfullscreen></iframe>
        <div class="player-placeholder">
            <p>Sélectionnez une langue et un lecteur pour commencer</p>
        </div>
    </div>
    {% else %}
    <p>Aucun lecteur disponible pour cet épisode.</p>
    {% endif %}
</div>

<script>
    const playersData = {{ players|tojson }};
    const languageSelect = document.getElementById('language-select');
    const playerSelect = document.getElementById('player-select');
    const playerFrame = document.getElementById('player-frame');
    const playerPlaceholder = document.querySelector('.player-placeholder');
    
    // Update player options when language changes
    languageSelect.addEventListener('change', updatePlayers);
    playerSelect.addEventListener('change', loadPlayer);
    
    function updatePlayers() {
        const selectedLang = languageSelect.value;
        const players = playersData[selectedLang] || [];
        
        playerSelect.innerHTML = players.map((player, index) => 
            `<option value="${index}">${player.hostname || 'Lecteur ' + (index + 1)}</option>`
        ).join('');
        
        if (players.length > 0) {
            loadPlayer();
        }
    }
    
    function loadPlayer() {
        const selectedLang = languageSelect.value;
        const selectedPlayerIndex = playerSelect.value;
        const players = playersData[selectedLang] || [];
        
        if (players.length > selectedPlayerIndex) {
            const playerUrl = players[selectedPlayerIndex].url;
            playerFrame.src = playerUrl;
            playerFrame.style.display = 'block';
            playerPlaceholder.style.display = 'none';
        }
    }
    
    // Initialize
    if (languageSelect.options.length > 0) {
        updatePlayers();
    }
</script>
{% endblock %}
