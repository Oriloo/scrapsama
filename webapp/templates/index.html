{% extends "base.html" %}

{% block content %}
<div class="hero">
    <h1>Bienvenue sur Scrapsama</h1>
    <p>Recherchez et regardez vos animes préférés</p>
    
    <div class="search-box">
        <input type="text" id="search-input" placeholder="Rechercher un anime..." autocomplete="off">
        <div id="search-results" class="search-results"></div>
    </div>
</div>

<div class="series-grid" id="series-grid">
    <h2>Animes disponibles</h2>
    <div class="loading">Chargement...</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const seriesGrid = document.getElementById('series-grid');
    
    let searchTimeout;
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchResults.innerHTML = '';
            searchResults.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displaySearchResults(data);
                });
        }, 300);
    });
    
    function displaySearchResults(series) {
        if (series.length === 0) {
            searchResults.innerHTML = '<div class="no-results">Aucun résultat trouvé</div>';
            searchResults.style.display = 'block';
            return;
        }
        
        searchResults.innerHTML = series.map(s => `
            <a href="/series/${s.id}" class="search-result-item">
                <img src="${s.image_url || '/static/img/placeholder.png'}" alt="${s.name}" onerror="this.src='/static/img/placeholder.png'">
                <div class="search-result-info">
                    <h3>${s.name}</h3>
                    <p>${s.categories.join(', ')}</p>
                </div>
            </a>
        `).join('');
        searchResults.style.display = 'block';
    }
    
    // Load recent series on page load
    fetch('/api/series')
        .then(response => response.json())
        .then(data => {
            displaySeriesGrid(data);
        });
    
    function displaySeriesGrid(series) {
        const loadingEl = seriesGrid.querySelector('.loading');
        if (loadingEl) loadingEl.remove();
        
        const gridHtml = series.map(s => `
            <a href="/series/${s.id}" class="series-card">
                <img src="${s.image_url || '/static/img/placeholder.png'}" alt="${s.name}" onerror="this.src='/static/img/placeholder.png'">
                <div class="series-card-info">
                    <h3>${s.name}</h3>
                    <p>${s.categories.join(', ')}</p>
                </div>
            </a>
        `).join('');
        
        seriesGrid.innerHTML = '<h2>Animes disponibles</h2>' + gridHtml;
    }
    
    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
</script>
{% endblock %}
